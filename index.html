<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Deepfake Detector - Multi</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f8f9fa; padding: 50px; }
        #drop-zone {
            width: 700px; height: 200px; border: 3px dashed #333; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            background-color: white; cursor: pointer; font-size: 1.2rem; font-weight: bold; margin-bottom: 30px;
        }
        #result-container { width: 700px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; margin-bottom: 30px; }
        .result-line { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 1.1rem; }
        .result-line:last-child { border-bottom: none; }
        .fake { color: #d32f2f; font-weight: bold; }
        .real { color: #1976d2; font-weight: bold; }
        #image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px; width: 750px;
        }
        .grid-item { width: 100%; height: 200px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; }
        #loading { display: none; margin-bottom: 20px; font-size: 1.2rem; color: #555; }
    </style>
</head>
<body>

    <h2>Deepfake Detection System</h2>
    <div id="drop-zone">여기에 1분 미만 영상 혹은 이미지들을 드랍하거나 클릭하여 선택하세요</div>
    <input type="file" id="file-input" style="display:none" accept="image/*" multiple>

    <div id="loading">이미지 분석 중... 잠시만 기다려주세요.</div>
    <div id="result-container"></div>
    <div id="image-grid"></div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const resultContainer = document.getElementById('result-container');
        const imageGrid = document.getElementById('image-grid');
        const loading = document.getElementById('loading');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.backgroundColor = "#e9ecef"; };
        dropZone.ondragleave = () => { dropZone.style.backgroundColor = "white"; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = "white";
            handleFiles(e.dataTransfer.files);
        };

        window.onpaste = (e) => {
            const items = e.clipboardData.items;
            let files = [];
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) files.push(items[i].getAsFile());
            }
            if (files.length > 0) handleFiles(files);
        };

        async function handleFiles(files) {
            if (files.length === 0) return;
            resultContainer.innerHTML = "";
            imageGrid.innerHTML = "";
            resultContainer.style.display = "none";
            loading.style.display = "block";

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
                
                // 프리뷰 생성 (이미지/영상 구분)
                const item = document.createElement(files[i].type.startsWith('video') ? 'video' : 'img');
                item.src = URL.createObjectURL(files[i]);
                item.className = 'grid-item';
                if (files[i].type.startsWith('video')) item.controls = true; // 영상인 경우 컨트롤 표시
                imageGrid.appendChild(item);
            }
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error(`서버 에러: ${response.status}`);

                const dataList = await response.json();

                // [수정] 중복 호출 제거 및 안전한 배열 체크
                if (dataList && Array.isArray(dataList)) {
                    displayResults(dataList);
                } else {
                    throw new Error("올바른 응답 형식이 아닙니다.");
                }
            } catch (error) {
                console.error(error);
                alert("분석 중 오류가 발생했습니다: " + error.message);
            } finally {
                loading.style.display = "none";
            }
        }

        function displayResults(dataList) {
            // 출력 전 컨테이너 비우기 (한 번 더 방어)
            resultContainer.innerHTML = "";
            resultContainer.style.display = "block";
            
            dataList.forEach(data => {
                const line = document.createElement('div');
                line.className = 'result-line';
                const verdictClass = data.result === "가짜" ? "fake" : "real";
                line.innerHTML = `<strong>${data.filename}</strong> | 결과 : <span class="${verdictClass}">${data.result}</span> (점수: ${data.score})`;
                resultContainer.appendChild(line);
            });
        }
    </script>
</body>
</html>